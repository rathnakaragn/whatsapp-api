---
import Base from '../layouts/Base.astro';
import { db, getIsConnected } from '../lib/server';

const isConnected = getIsConnected();

// Get webhooks from database
const webhooks = db.prepare("SELECT * FROM webhooks ORDER BY created_at DESC").all();

// Handle toast from redirect
const toast = Astro.url.searchParams.get('toast');
const toastType = Astro.url.searchParams.get('type') || 'success';

const AVAILABLE_EVENTS = [
  { value: 'message.received', label: 'Message Received' },
  { value: 'message.sent', label: 'Message Sent' },
  { value: 'connection.connected', label: 'Connection Established' },
  { value: 'connection.disconnected', label: 'Connection Lost' },
];
---

<Base title="Webhooks" connected={isConnected}>
  <div>
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold dark:text-white">Webhooks</h2>
      <a
        href="/webhooks/new"
        class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors"
      >
        Add Webhook
      </a>
    </div>

    <p class="text-gray-600 dark:text-gray-400 mb-6">
      Webhooks allow external systems to receive real-time notifications when events occur.
    </p>

    {webhooks.length === 0 ? (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-8 text-center text-gray-500 dark:text-gray-400">
        <p>No webhooks configured</p>
      </div>
    ) : (
      <div class="space-y-4">
        {webhooks.map((webhook: any) => (
          <div
            class={`bg-white dark:bg-gray-800 rounded-lg shadow p-6 ${!webhook.active ? 'opacity-60' : ''}`}
          >
            <div class="flex justify-between items-start mb-3">
              <div class="font-mono text-sm break-all dark:text-white">{webhook.url}</div>
              <span class={`px-2 py-1 rounded text-xs font-medium ${webhook.active ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400'}`}>
                {webhook.active ? 'Active' : 'Inactive'}
              </span>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
              {webhook.events.split(',').map((event: string) => (
                <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-xs">
                  {event}
                </span>
              ))}
            </div>

            <div class="flex flex-wrap gap-2">
              <form method="POST" action="/actions/webhook-toggle">
                <input type="hidden" name="id" value={webhook.id} />
                <input type="hidden" name="active" value={webhook.active ? '0' : '1'} />
                <button
                  type="submit"
                  class="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm"
                >
                  {webhook.active ? 'Disable' : 'Enable'}
                </button>
              </form>
              <a
                href={`/webhooks/edit/${webhook.id}`}
                class="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm"
              >
                Edit
              </a>
              <form method="POST" action="/actions/webhook-delete">
                <input type="hidden" name="id" value={webhook.id} />
                <button
                  type="submit"
                  class="px-3 py-1.5 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm"
                  onclick="return confirm('Are you sure you want to delete this webhook?')"
                >
                  Delete
                </button>
              </form>
            </div>
          </div>
        ))}
      </div>
    )}

    {toast && (
      <div class={`fixed bottom-8 right-8 px-6 py-4 rounded-lg text-white font-medium z-50 ${
        toastType === 'error' ? 'bg-red-500' : 'bg-green-500'
      }`}>
        {toast}
      </div>
    )}
  </div>
</Base>
