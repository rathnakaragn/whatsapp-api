---
import Base from '../../layouts/Base.astro';
import { db, getIsConnected } from '../../lib/server';

const isConnected = getIsConnected();
const { id } = Astro.params;

const message = db.prepare("SELECT * FROM messages WHERE id = ?").get(id);

if (!message) {
  return Astro.redirect('/?toast=Message not found&type=error');
}

const redirect = Astro.url.searchParams.get('redirect') || '/';
const formatPhone = (jid: string) => jid.replace('@s.whatsapp.net', '').replace('@g.us', ' (group)');
const formatDate = (timestamp: string) => new Date(timestamp).toLocaleString();
---

<Base title="Reply" connected={isConnected}>
  <div>
    <h2 class="text-2xl font-semibold mb-6 dark:text-white">Reply to Message</h2>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
      <div class="mb-4">
        <span class="text-sm text-gray-500 dark:text-gray-400">From:</span>
        <span class="font-semibold dark:text-white ml-2">{formatPhone(message.phone)}</span>
      </div>
      <div class="mb-4">
        <span class="text-sm text-gray-500 dark:text-gray-400">Received:</span>
        <span class="dark:text-white ml-2">{formatDate(message.created_at)}</span>
      </div>
      <div class="p-4 bg-gray-100 dark:bg-gray-900 rounded-lg">
        {message.media_url && message.media_type === 'image' && (
          <img src={message.media_url} alt="Media" class="max-w-full max-h-72 rounded mb-3" />
        )}
        {message.media_url && message.media_type === 'video' && (
          <video src={message.media_url} controls class="max-w-full max-h-72 rounded mb-3" />
        )}
        <p class="whitespace-pre-wrap break-words dark:text-gray-200">{message.message}</p>
      </div>
    </div>

    {!isConnected ? (
      <div class="bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 p-4 rounded-lg mb-6">
        WhatsApp is not connected. Please connect first to send replies.
      </div>
    ) : (
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <form method="POST" action="/actions/reply">
          <input type="hidden" name="id" value={id} />
          <input type="hidden" name="redirect" value={redirect} />

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Your Reply
            </label>
            <textarea
              name="message"
              rows="4"
              required
              placeholder="Type your reply..."
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent resize-y"
            ></textarea>
          </div>

          <div class="flex gap-3 justify-end">
            <a
              href={redirect}
              class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              Cancel
            </a>
            <button
              type="submit"
              class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
            >
              Send Reply
            </button>
          </div>
        </form>
      </div>
    )}
  </div>
</Base>
